<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/util
	http://www.springframework.org/schema/util/spring-util-2.5.xsd">

	<bean
		class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
		<property name="location" value="classpath:project.properties" />
	</bean>

	<bean id="defaultEventConsumerFactory1"
		class="com.flipkart.payzippy.eventconsumer.implementation.DefaultEventConsumerFactoryBean">
		<property name="mapper" ref="defaultMapperImpl" />
		<property name="destStoreOperationsMap">
			<map>
				<entry key-ref="upsertDbusOpCode" value-ref="hBaseUpsertDataLayer" />
				<entry key-ref="deleteDbusOpCode" value-ref="hBaseDeleteDataLayer" />
			</map>
		</property>
		<property name="sourceEventFactory" ref="sourceEventFactory" />
		<property name="destinationGroupSet">
			<set>
				<value>1</value>
			</set>
		</property>
	</bean>

	<bean id="defaultEventConsumerFactory2"
		class="com.flipkart.payzippy.eventconsumer.implementation.DefaultEventConsumerFactoryBean">
		<property name="mapper" ref="defaultMapperImpl" />
		<property name="destStoreOperationsMap">
			<map>
				<entry key-ref="upsertDbusOpCode" value-ref="hBaseUpsertDataLayer" />
				<entry key-ref="deleteDbusOpCode" value-ref="hBaseDeleteDataLayer" />
			</map>
		</property>
		<property name="sourceEventFactory" ref="sourceEventFactory" />
		<property name="destinationGroupSet">
			<set>
				<value>2</value>
			</set>
		</property>
	</bean>

	<bean id="defaultMapperImpl"
		class="com.flipkart.payzippy.mapper.implementation.DefaultMapperImpl">
		<property name="configFilePath" value="${MAPPER_CONFIG_FILE_PATH}" />
		<property name="configRoot" value="HBASE_CONFIG" />
		<property name="mapperConfig" ref="mapperConfig" />
		<property name="mapperTypeList">
			<list>
				<ref bean="noNamespaceEntityMapperType" />
				<ref bean="noEntityMapperType" />
				<ref bean="namespaceEntityMapperType" />
			</list>
		</property>
		<property name="eventGroupFinder" ref="defaultEventGroupFinder" />
		<property name="destinationEventFactory" ref="destinationEventFactory" />
	</bean>

	<util:constant id="upsertDbusOpCode"
		static-field="com.linkedin.databus.core.DbusOpcode.UPSERT" />
	<util:constant id="deleteDbusOpCode"
		static-field="com.linkedin.databus.core.DbusOpcode.DELETE" />

	<bean id="mapperConfig"
		class="com.flipkart.payzippy.mapper.config.implementation.MapperConfigImpl"
		factory-method="getInstance" />

	<util:constant id="noNamespaceEntityMapperType"
		static-field="com.flipkart.payzippy.mapper.implementation.MapperType.MAP_WITHOUT_SOURCE_NAMESPACE_ENTITY_CONFIG" />
	<util:constant id="noEntityMapperType"
		static-field="com.flipkart.payzippy.mapper.implementation.MapperType.MAP_WITHOUT_SOURCE_ENTITY_CONFIG" />
	<util:constant id="namespaceEntityMapperType"
		static-field="com.flipkart.payzippy.mapper.implementation.MapperType.MAP_WITH_SOURCE_ENTITY_CONFIG" />

	<bean id="defaultEventGroupFinder"
		class="com.flipkart.payzippy.mapper.eventGroupFilter.implementation.DefaultEventGroupFinderImpl"
		factory-method="getInstance" />

	<bean id="destinationEventFactory"
		class="com.flipkart.payzippy.event.implementation.DestinationEventFactory" />

	<bean id="sourceEventFactory"
		class="com.flipkart.payzippy.event.implementation.SourceEventFactory" />

	<bean id="hbaseConfig" class="com.flipkart.payzippy.hbasedatalayer.config.HBaseConfig">
		<constructor-arg type="java.lang.String" value="${HBASE_ZOOKEEPER_QUORUM}" />
		<property name="hBaseZookeeperClientPort" value="${HBASE_ZOOKEEPER_CLIENT_PORT}" />
		<property name="zookeeperZnodeParent" value="${HBASE_ZOOKEEPER_ZNODE_PARENT}" />
	</bean>

	<bean id="hBaseUpsertDataLayer"
		class="com.flipkart.payzippy.hbasedatalayer.upsert.HBaseUpsertDataLayerFactory ">
		<property name="dataSourceMap" ref="dataSourceMap" />
	</bean>

	<bean id="hBaseDeleteDataLayer"
		class="com.flipkart.payzippy.hbasedatalayer.delete.HBaseDeleteDataLayerFactory">
		<property name="dataSourceMap" ref="dataSourceMap" />
	</bean>

	<util:map id="dataSourceMap">
		<entry key="">
			<ref bean="dataSource1"></ref>
		</entry>
		<entry key="payment">
			<ref bean="dataSource1"></ref>
		</entry>
	</util:map>

	<bean id="dataSource1" class="com.mchange.v2.c3p0.ComboPooledDataSource">
		<property name="driverClass" value="org.apache.phoenix.jdbc.PhoenixDriver" />
		<property name="jdbcUrl" value="#{hbaseConfig.getConnectionUrl()}" />
		<property name="properties">
			<props>
				<prop key="c3p0.acquire_increment">5</prop>
				<prop key="c3p0.idle_test_period">100</prop>
				<prop key="c3p0.max_size">50</prop>
				<prop key="c3p0.max_statements">0</prop>
				<prop key="c3p0.min_size">5</prop>
				<prop key="c3p0.testConnectionOnCheckin">true</prop>
			</props>
		</property>
		<property name="maxIdleTime" value="3600" />
		<property name="idleConnectionTestPeriod" value="300" />
		<property name="testConnectionOnCheckin" value="true" />
		<property name="preferredTestQuery" value="select 1 from dual" />
	</bean>

	<bean id="clusterRegistration" class="com.flipkart.aesop.runtime.config.ClusterRegistration"
		abstract="true">
		<property name="logicalSources">
			<list value-type="java.lang.String">
				<value>pz.payment.TransactionMaster</value>
				<value>pz.payment.TransactionUserDetail</value>
				<value>pz.payment.TransactionSaleDetail</value>
				<value>pz.payment.TransactionAuditSummary</value>
				<value>pz.payment.TransactionFingerprint</value>
				<value>pz.payment.TransactionCardDetail</value>
				<value>pz.payment.TransactionFraudStatus</value>
				<value>pz.payment.TransactionPGResponse</value>
				<value>pz.payment.PayZippyUserProfile</value>
				<value>pz.payment.TransactionRefundPGTrack</value>
				<value>pz.payment.TransactionRefundDetail</value>
				<value>pz.payment.TransactionSettlement</value>
				<value>pz.payment.TransactionPGTrack</value>
				<value>pz.payment.RelatedTransaction</value>
				<value>pz.payment.OfflineAdjustmentDetails</value>
				<value>pz.payment.TransactionAdjustmentDetail</value>
			</list>
		</property>
	</bean>

	<bean id="sampleClient"
		class="com.flipkart.aesop.runtime.clusterclient.DefaultClusterClientFactory">
		<property name="clientClusterConfig" ref="clientClusterConfig" />
		<property name="clusterRegistrations">
			<list>
				<bean parent="clusterRegistration">
					<property name="clusterName" value="pz_hbase_cluster_denormalized" />
					<property name="consumerFactory">
						<bean class="com.flipkart.payzippy.eventconsumer.ConsumerFactory">
							<property name="eventConsumerFactoryList">
								<list>
									<ref bean="defaultEventConsumerFactory1" />
								</list>
							</property>
							<property name="totalDestinationGroups" value="2" />
						</bean>
					</property>
				</bean>
				<bean parent="clusterRegistration">
					<property name="clusterName" value="pz_hbase_cluster_onetoone" />
					<property name="consumerFactory">
						<bean class="com.flipkart.payzippy.eventconsumer.ConsumerFactory">
							<property name="eventConsumerFactoryList">
								<list>
									<ref bean="defaultEventConsumerFactory2" />
								</list>
							</property>
							<property name="totalDestinationGroups" value="2" />
						</bean>
					</property>
				</bean>
			</list>
		</property>
	</bean>

	<bean id="clientClusterConfig" class="com.flipkart.aesop.runtime.config.ClientClusterConfig">
		<property name="clientProperties">
			<bean id="clientPropertiesFactory"
				class="org.springframework.beans.factory.config.PropertiesFactoryBean">
				<property name="singleton" value="true" />
				<property name="properties">
					<props>
						<prop key="databus.client.container.httpPort">11125</prop>
						<prop key="databus.client.container.jmx.rmiEnabled">false</prop>
						<prop key="databus.client.connectionDefaults.pullerRetries.initSleep">1</prop>
						<prop
							key="databus.client.connectionDefaults.pullerRetries.maxRetryNum">-1</prop>
						<prop key="databus.client.checkpointPersistence.clearBeforeUse">false</prop>
						<prop
							key="databus.client.connectionDefaults.enablePullerMessageQueueLogging">false</prop>
						<prop key="databus.client.container.httpPort">11125</prop>
					</props>
				</property>
			</bean>
		</property>
		<property name="relayClientConfigs">
			<list>
				<bean class="com.flipkart.aesop.runtime.config.RelayClientConfig">
					<property name="relayId" value="1" />
					<property name="relayHost" value="${RELAY_HOST}" />
					<property name="relayPort" value="25021" />
					<property name="relayLogicalSourceNames">
						<list value-type="java.lang.String">
							<value>pz.payment.TransactionMaster</value>
							<value>pz.payment.TransactionUserDetail</value>
							<value>pz.payment.TransactionSaleDetail</value>
							<value>pz.payment.TransactionAuditSummary</value>
							<value>pz.payment.TransactionFingerprint</value>
							<value>pz.payment.TransactionCardDetail</value>
							<value>pz.payment.TransactionFraudStatus</value>
							<value>pz.payment.TransactionPGResponse</value>
							<value>pz.payment.PayZippyUserProfile</value>
							<value>pz.payment.TransactionRefundPGTrack</value>
							<value>pz.payment.TransactionRefundDetail</value>
							<value>pz.payment.TransactionSettlement</value>
							<value>pz.payment.TransactionPGTrack</value>
							<value>pz.payment.RelatedTransaction</value>
							<value>pz.payment.OfflineAdjustmentDetails</value>
							<value>pz.payment.TransactionAdjustmentDetail</value>
						</list>
					</property>
				</bean>
			</list>
		</property>
		<property name="clusterInfoConfigs">
			<list>
				<bean class="com.flipkart.aesop.runtime.config.ClusterInfoConfig">
					<property name="id" value="1" />
					<property name="clusterName" value="pz_hbase_cluster_denormalized" />
					<property name="zkAddr" value="${ZK_ADDR}" />
					<property name="numPartitions" value="${NUM_PARTITIONS}" />
					<property name="quorum" value="1" />
					<property name="zkSessionTimeoutMs" value="60000" />
					<property name="zkConnectionTimeoutMs" value="60000" />
					<property name="checkpointIntervalMs" value="300000" />
				</bean>
				<bean class="com.flipkart.aesop.runtime.config.ClusterInfoConfig">
					<property name="id" value="2" />
					<property name="clusterName" value="pz_hbase_cluster_onetoone" />
					<property name="zkAddr" value="${ZK_ADDR}" />
					<property name="numPartitions" value="${NUM_PARTITIONS}" />
					<property name="quorum" value="1" />
					<property name="zkSessionTimeoutMs" value="60000" />
					<property name="zkConnectionTimeoutMs" value="60000" />
					<property name="checkpointIntervalMs" value="300000" />
				</bean>
			</list>
		</property>

		<property name="checkpointDirectoryLocation" value="${CHECKPOINT_DIR_LOCATION}" /> <!-- This is relative to projects root -->
	</bean>
</beans>
